pipeline {
    agent any
    
    environment {
        DOTNET_VERSION = '8.0'
        APP_NAME = 'SampleJenkinsDeploy'
        DEPLOY_PATH = '/var/www/sample-app'
        DOCKER_IMAGE_NAME = 'sample-jenkins-deploy'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
    }
    
    stages {
        // Stage 1: Checkout code
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }
        
        // Stage 2: Setup .NET
        stage('Setup .NET') {
            steps {
                echo 'Setting up .NET environment...'
                sh 'dotnet --version'
            }
        }
        
        // Stage 3: Restore packages
        stage('Restore') {
            steps {
                echo 'Restoring NuGet packages...'
                sh 'dotnet restore'
            }
        }
        
        // Stage 4: Build solution
        stage('Build') {
            steps {
                echo 'Building solution...'
                sh 'dotnet build --configuration Release --no-restore'
                
                // Archive build artifacts
                archiveArtifacts artifacts: '**/bin/Release/**/*.dll', fingerprint: true
            }
        }
        
        // Stage 5: Run tests
        stage('Test') {
            steps {
                echo 'Running tests...'
                sh 'dotnet test --configuration Release --no-build --verbosity normal --logger:"trx;LogFileName=testresults.trx"'
                
                // Publish test results
                junit '**/TestResults/*.trx'
            }
        }
        
        // Stage 6: Publish application
        stage('Publish') {
            steps {
                echo 'Publishing application...'
                sh 'dotnet publish --configuration Release --no-build --output ./publish'
                
                // Archive published files
                archiveArtifacts artifacts: 'publish/**/*', fingerprint: true
            }
        }
        
        // Stage 7: Build Docker image (optional)
        stage('Build Docker Image') {
            when {
                environment name: 'BUILD_DOCKER', value: 'true'
            }
            steps {
                echo 'Building Docker image...'
                script {
                    docker.build("${DOCKER_IMAGE_NAME}:${DOCKER_TAG}", "--file Dockerfile .")
                }
            }
        }
        
        // Stage 8: Deploy (Choose one method)
        stage('Deploy') {
            parallel {
                // Option A: Deploy to folder (for IIS/Linux service)
                stage('Deploy to Folder') {
                    steps {
                        echo 'Deploying to target folder...'
                        script {
                            sh '''
                                sudo mkdir -p ${DEPLOY_PATH}
                                sudo cp -r ./publish/* ${DEPLOY_PATH}/
                                sudo chmod -R 755 ${DEPLOY_PATH}
                            '''
                        }
                    }
                }
                
                // Option B: Deploy with Docker Compose
                stage('Deploy with Docker Compose') {
                    when {
                        environment name: 'USE_DOCKER_COMPOSE', value: 'true'
                    }
                    steps {
                        echo 'Deploying with Docker Compose...'
                        sh 'docker-compose down'
                        sh 'docker-compose up -d --build'
                    }
                }
                
                // Option C: Deploy to Azure (example)
                stage('Deploy to Azure') {
                    when {
                        environment name: 'DEPLOY_TO_AZURE', value: 'true'
                    }
                    steps {
                        withCredentials([azureServicePrincipal('AZURE_CREDENTIALS')]) {
                            sh '''
                                az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
                                az webapp deployment source config-zip --resource-group myResourceGroup --name myWebApp --src ./publish.zip
                            '''
                        }
                    }
                }
            }
        }
        
        // Stage 9: Health check
        stage('Health Check') {
            steps {
                echo 'Performing health check...'
                script {
                    // Wait for app to start
                    sleep 10
                    
                    // Check if application is responding
                    def response = sh(script: 'curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/health', returnStdout: true).trim()
                    
                    if (response == '200') {
                        echo 'Health check passed!'
                    } else {
                        error "Health check failed! HTTP Status: ${response}"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully!'
            
            // Send success notification
            emailext (
                subject: "SUCCESS: Pipeline ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: "The pipeline completed successfully.\nCheck: ${env.BUILD_URL}",
                to: 'team@example.com'
            )
        }
        failure {
            echo 'Pipeline failed!'
            
            // Send failure notification
            emailext (
                subject: "FAILURE: Pipeline ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: "The pipeline failed.\nCheck: ${env.BUILD_URL}",
                to: 'team@example.com'
            )
        }
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
            
            // Archive build artifacts
            archiveArtifacts artifacts: '**/publish/**/*', allowEmptyArchive: true
        }
    }
}